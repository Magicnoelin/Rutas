<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Evento Cultural - Rutas</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.google.com/recaptcha/api.js?render=6LeHyRgsAAAAAPpK8PcEp2iuvMEE4wSoUpfpH89k"></script>
    <script src="config.js"></script>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="container">
                <div class="logo">
                    <img src="logo_990x1076_verde.png" alt="Rutas Logo" style="height: 50px; margin-right: 10px;">
                    <span>Rutas</span>
                </div>
                <button class="hamburger" id="hamburger" aria-label="Menú">
                    <span></span><span></span><span></span>
                </button>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="alojamientos.html">Alojamientos</a></li>
                    <li><a href="eventos-culturales.html">Eventos Culturales</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="form-container">
        <div class="form-header">
            <h1><i class="fas fa-calendar-plus"></i> Agregar Evento Cultural</h1>
            <p>Completa el formulario para añadir un nuevo evento cultural</p>
        </div>

        <form id="eventoForm">
            <div class="form-section">
                <h3><i class="fas fa-info-circle"></i> Información Básica</h3>
                <div class="form-group">
                    <label for="title">Título del Evento <span class="required">*</span></label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">Categoría <span class="required">*</span></label>
                        <select id="category" name="category" required>
                            <option value="Música">Música</option>
                            <option value="Teatro">Teatro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="event_date">Fecha <span class="required">*</span></label>
                        <input type="date" id="event_date" name="event_date" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="location">Ubicación <span class="required">*</span></label>
                    <input type="text" id="location" name="location" required>
                </div>
                <div class="form-group">
                    <label for="description">Descripción <span class="required">*</span></label>
                    <textarea id="description" name="description" required></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-submit">
                    <i class="fas fa-save"></i> Guardar Evento
                </button>
            </div>
        </form>

        <div class="preview-container" id="previewContainer">
            <div class="preview-header">
                <h3 id="resultTitle">Resultado</h3>
                <p id="resultMessage">Información del proceso</p>
            </div>
        </div>
    </div>

    <script>
        async function guardarEvento() {
            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.innerHTML;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

                const formData = {
                    title: document.getElementById('title').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    event_date: document.getElementById('event_date').value,
                    location: document.getElementById('location').value.trim(),
                    category: document.getElementById('category').value
                };

                const recaptchaToken = await grecaptcha.execute('6LeHyRgsAAAAAPpK8PcEp2iuvMEE4wSoUpfpH89k', {action: 'submit'});
                formData.recaptchaToken = recaptchaToken;

                const apiUrl = window.CONFIG?.API_BASE_URL
                    ? `${window.CONFIG.API_BASE_URL}/crear_evento.php`
                    : 'api/crear_evento.php';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                let errorMessage = '';

                if (response.ok) {
                    try {
                        const result = await response.json();
                        if (result.success) {
                            mostrarMensajeExito(result);
                            return;
                        } else {
                            errorMessage = result.error || result.message || 'Error del servidor';
                        }
                    } catch (jsonError) {
                        errorMessage = 'Respuesta inválida del servidor';
                    }
                } else {
                    // Try to get error details from response
                    try {
                        const result = await response.json();
                        errorMessage = result.error || result.message || `Error ${response.status}`;
                    } catch (jsonError) {
                        errorMessage = `Error del servidor: ${response.status} ${response.statusText}`;
                    }
                }

                mostrarMensajeError(errorMessage);

            } catch (error) {
                mostrarMensajeError('Error de conexión: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        function mostrarMensajeExito(result) {
            document.getElementById('resultTitle').innerHTML = '<i class="fas fa-check-circle"></i> ¡Evento Guardado!';
            document.getElementById('resultMessage').textContent = `ID: ${result.data.id}, Título: ${result.data.title}`;
            document.getElementById('previewContainer').classList.add('active');
        }

        function mostrarMensajeError(errorMsg) {
            document.getElementById('resultTitle').innerHTML = '<i class="fas fa-exclamation-circle"></i> Error';
            document.getElementById('resultMessage').textContent = errorMsg;
            document.getElementById('previewContainer').classList.add('active');
        }

        document.getElementById('eventoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            guardarEvento();
        });
    </script>
</body>
</html>
